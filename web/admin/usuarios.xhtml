<ui:composition template="/templates/template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:define name="content">
        <div class="page-container">

            <!-- PANEL IZQUIERDO: FORMULARIO -->
            <div class="form-panel">
                 <div class="card form-card">
                    <h:form id="formPanel">
                        <input type="hidden" name="csrfToken" value="#{sessionScope.csrfToken}" />
                        
                        <h3>#{empty usuarioBean.usuarioSeleccionado.idUsuario ? 'Crear Nuevo Usuario' : 'Editando Usuario'}</h3>
                        
                        <p:messages id="formMessages" showDetail="true" closable="true"><p:autoUpdate/></p:messages>
                        
                        <div class="form-grid">
                            <p:outputLabel for="nombres" value="Nombres" styleClass="required"/>
                            <p:inputText id="nombres" value="#{usuarioBean.usuarioSeleccionado.nombres}" required="true"/>

                            <p:outputLabel for="apellidos" value="Apellidos" styleClass="required"/>
                            <p:inputText id="apellidos" value="#{usuarioBean.usuarioSeleccionado.apellidos}" required="true"/>

                            <p:outputLabel for="documento" value="Documento" styleClass="required"/>
                            <p:inputText id="documento" value="#{usuarioBean.usuarioSeleccionado.documento}" required="true"/>
                            
                            <p:outputLabel for="correo" value="Correo" styleClass="required"/>
                            <p:inputText id="correo" value="#{usuarioBean.usuarioSeleccionado.correo}" required="true"/>

                            <p:outputLabel for="telefono" value="Teléfono"/>
                            <p:inputText id="telefono" value="#{usuarioBean.usuarioSeleccionado.telefono}"/>

                            <p:outputLabel for="rol" value="Rol" styleClass="required"/>
                            <p:selectOneMenu id="rol" value="#{usuarioBean.usuarioSeleccionado.idRol}" required="true">
                                <f:selectItem itemLabel="Seleccione un rol" itemValue="#{null}" noSelectionOption="true"/>
                                <f:selectItems value="#{usuarioBean.listaRoles}" var="r" itemValue="#{r.idRol}" itemLabel="#{r.descripcionRol}"/>
                            </p:selectOneMenu>

                            <p:outputLabel for="estado" value="Estado" styleClass="required"/>
                            <p:selectOneMenu id="estado" value="#{usuarioBean.usuarioSeleccionado.estadoUsuario}" required="true">
                                <f:selectItem itemLabel="Activo" itemValue="1"/><f:selectItem itemLabel="Inactivo" itemValue="0"/><f:selectItem itemLabel="Suspendido" itemValue="2"/>
                            </p:selectOneMenu>

                            <p:outputLabel for="pass" value="Contraseña" styleClass="#{empty usuarioBean.usuarioSeleccionado.idUsuario ? 'required' : ''}"/>
                            <p:password id="pass" value="#{usuarioBean.nuevaContrasena}" 
                                        placeholder="#{empty usuarioBean.usuarioSeleccionado.idUsuario ? '' : '(No cambiar)'}"
                                        required="#{empty usuarioBean.usuarioSeleccionado.idUsuario}"/>
                        </div>
                        
                        <div class="form-actions">
                            <p:commandButton value="Guardar" actionListener="#{usuarioBean.guardarCambios()}" update=":adminForm:tablaUsuarios :formPanel" icon="pi pi-save" styleClass="ui-button-primary btn-glow-primary"/>
                            <p:commandButton value="Limpiar" actionListener="#{usuarioBean.prepararNuevoUsuario()}" update=":formPanel" icon="pi pi-eraser" styleClass="ui-button-secondary" process="@this"/>
                        </div>
                    </h:form>
                </div>
            </div>

            <!-- PANEL DERECHO: TABLA DE USUARIOS -->
            <div class="table-panel">
                <div class="card admin-card">
                    <h2>Gestión de Usuarios</h2>
                    <p>Seleccione un usuario para editarlo o cree uno nuevo.</p>

                    <div class="table-responsive-wrapper">
                        <h:form id="adminForm">
                            <input type="hidden" name="csrfToken" value="#{sessionScope.csrfToken}" />

                            <p:dataTable id="tablaUsuarios" widgetVar="tablaUsuariosWV" value="#{usuarioBean.listaUsuarios}" var="u"
                                         paginator="true" rows="8" resizableColumns="false"
                                         styleClass="custom-datatable" emptyMessage="No se encontraron usuarios"
                                         reflow="true">

                                <p:column headerText="Correo" sortBy="#{u.correo}" filterBy="#{u.correo}" filterMatchMode="contains" styleClass="col-correo">
                                    <h:outputText value="#{u.correo}" />
                                </p:column>
                                <p:column headerText="Nombre completo" sortBy="#{u.nombres}" filterBy="#{u.nombres}" filterMatchMode="contains" styleClass="col-nombre">
                                    <h:outputText value="#{u.nombres} #{u.apellidos}" />
                                </p:column>
                                <p:column headerText="Rol" sortBy="#{usuarioBean.getDescripcionRol(u.idRol)}" filterBy="#{usuarioBean.getDescripcionRol(u.idRol)}" filterMatchMode="equals" styleClass="col-rol">
                                    <f:facet name="filter"><p:selectOneMenu onchange="PF('tablaUsuariosWV').filter()"><f:selectItem itemLabel="Todos" itemValue="#{null}" noSelectionOption="true" /><f:selectItems value="#{usuarioBean.listaRoles}" var="r" itemValue="#{r.descripcionRol}" itemLabel="#{r.descripcionRol}" /></p:selectOneMenu></f:facet>
                                    <h:outputText value="#{usuarioBean.getDescripcionRol(u.idRol)}" />
                                </p:column>
                                <p:column headerText="Estado" styleClass="col-estado">
                                    <h:outputText value="#{u.estadoUsuario eq 1 ? 'Activo' : 'Inactivo'}" styleClass="#{u.estadoUsuario eq 1 ? 'estado-activo' : 'estado-inactivo'}" />
                                </p:column>
                                <p:column headerText="Acciones" styleClass="col-acciones">
                                    <p:commandButton value="Editar" title="Editar este usuario" actionListener="#{usuarioBean.prepararEdicion(u)}" update=":formPanel" styleClass="ui-button-info" process="@this">
                                        <span class="material-symbols-outlined">edit</span>
                                    </p:commandButton>
                                    <p:commandButton value="Eliminar" title="Eliminar este usuario" actionListener="#{usuarioBean.eliminar(u)}" update=":adminForm:tablaUsuarios :formPanel" styleClass="ui-button-danger">
                                        <span class="material-symbols-outlined">delete</span>
                                        <p:confirm header="Confirmación" message="¿Seguro que deseas eliminar a #{u.nombres}?" icon="pi pi-exclamation-triangle"/>
                                    </p:commandButton>
                                </p:column>
                            </p:dataTable>
                            <p:confirmDialog global="true"><p:commandButton value="Sí, eliminar" type="button" styleClass="ui-confirmdialog-yes ui-button-danger"/><p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary"/></p:confirmDialog>
                        </h:form>
                    </div>
                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>